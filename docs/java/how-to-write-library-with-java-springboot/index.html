<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java/how-to-write-library-with-java-springboot" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Viết library với annotation, reflection, aop, springboot | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://trandanhhoang.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://trandanhhoang.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://trandanhhoang.github.io/docs/java/how-to-write-library-with-java-springboot"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Viết library với annotation, reflection, aop, springboot | My Site"><meta data-rh="true" name="description" content="Tóm tắt"><meta data-rh="true" property="og:description" content="Tóm tắt"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://trandanhhoang.github.io/docs/java/how-to-write-library-with-java-springboot"><link data-rh="true" rel="alternate" href="https://trandanhhoang.github.io/docs/java/how-to-write-library-with-java-springboot" hreflang="en"><link data-rh="true" rel="alternate" href="https://trandanhhoang.github.io/docs/java/how-to-write-library-with-java-springboot" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.1c022e41.css">
<script src="/assets/js/runtime~main.c06bca90.js" defer="defer"></script>
<script src="/assets/js/main.32127e28.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Tran Danh Hoang</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Java-Springboot</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/java">Java</a><button aria-label="Collapse sidebar category &#x27;Java&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/java/kafka-with-java-springboot-example">Ví dụ kafka + java springboot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/java/how-to-write-library-with-java-springboot">Viết library với annotation, reflection, aop, springboot</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/kafka/kafka-basic">kafka</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Viết library với annotation, reflection, aop, springboot</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Viết library với annotation, reflection, aop, springboot</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tóm-tắt">Tóm tắt<a href="#tóm-tắt" class="hash-link" aria-label="Direct link to Tóm tắt" title="Direct link to Tóm tắt">​</a></h2>
<ul>
<li>
<p>Hướng dẫn viết 1 thư viện cơ bản dùng annotation, reflection, aop, springboot.</p>
<ul>
<li>Mục đích: check idempotent của 1 api controller dựa trên request param</li>
<li>Cách hoạt động: Từ request đầu tiên, chúng ta sẽ lưu key vào redis, từ những field cần thiết, request tiếp theo sẽ được kiềm tra, nếu key đã tồn tại thì trả về lỗi.</li>
<li>Cách dùng: đánh annotation trên các method của Controller, ứng với mỗi method sẽ có 1 bean riêng biệt (gọi là IdempotantEngine- được tạo ra từ lúc khởi chạy project), để lấy key, lưu key, handle exception (chúng ta có thể tuỳ biến 3 task này dựa vào annotation).</li>
</ul>
</li>
<li>
<p>Ví dụ:</p>
</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Idempotent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id = &quot;abc&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clazz = Request.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s = &quot;name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handleIdempotent = @Handle(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handlerClass = CustomIdempotentHandler.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void foo(String arg1, Request arg2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // do some controller thing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Ý nghĩa của Annotation trên:<!-- -->
<ul>
<li>id: vì mỗi method sẽ có 1 IdempotantEngine khác nhau, chúng ta sẽ tạo ra 1 <code>Map&lt;String,IdempotantEngine&gt;</code>với key là id để lấy ra engine cần thiết.</li>
<li>index = 1, clazz = Request.class, s = &quot;name&quot;<!-- -->
<ul>
<li>Trong request có 2 field, index = 1 để xác định chúng ta sẽ lấy field thứ 2, clazz = Request.class + field=&quot;name&quot;, chúng ta sẽ dùng reflection để lấy field name làm key.</li>
</ul>
</li>
<li>@Handle(handlerClass = CustomIdempotentHandler.class))<!-- -->
<ul>
<li>là 1 class implement IdempotentHandler, chúng ta có thể tuỳ biến logic handle exception ở đây, có thể throw, log, không ph  ụ thuộc vào thư viện</li>
</ul>
</li>
</ul>
</li>
<li>Các class bổ sung context bên trên</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Request {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomIdempotentHandler implements IdempotentHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CustomIdempotentHandler() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object handle(Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;hoang is here&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RuntimeException(&quot;idempotent detected&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prequisites">Prequisites<a href="#prequisites" class="hash-link" aria-label="Direct link to Prequisites" title="Direct link to Prequisites">​</a></h2>
<ul>
<li>Annotation</li>
<li>Reflection</li>
<li>Bean trong Springboot</li>
<li>Aspect Oriented Programming</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="project-structure">Project structure<a href="#project-structure" class="hash-link" aria-label="Direct link to Project structure" title="Direct link to Project structure">​</a></h2>
<ul>
<li>spi: logic chính của thư viện<!-- -->
<ul>
<li>implementation logic code cơ bản để lưu key, check idempotent, trả lỗi.</li>
</ul>
</li>
<li>annotation: chứa annotation (Idempotent) để đánh dấu trên method của controller, và annotation con (Handle) của nó.<!-- -->
<ul>
<li>annotation con giúp chúng ta thay đổi cơ chế persistant key (redis, database, memory, ...) tuỳ thích.</li>
</ul>
</li>
<li>spring: constructor để tạo các bean của spi<!-- -->
<ul>
<li>Tạo các bean trong thư viện từ project chính (ứng với mỗi method sẽ có 1 bean riêng biệt được tạo ra để lấy key, lưu key, handle exception (chúng ta có thể tuỳ biến 3 việc này dựa vào annotation)</li>
</ul>
</li>
<li>aop: logic aop để gọi chính xác spi dựa trên annotation</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hiện-thực">Hiện thực<a href="#hiện-thực" class="hash-link" aria-label="Direct link to Hiện thực" title="Direct link to Hiện thực">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tạo-spi">Tạo spi<a href="#tạo-spi" class="hash-link" aria-label="Direct link to Tạo spi" title="Direct link to Tạo spi">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.libselflearn.library;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SimpleIdempotentEngine implements IdempotentEngine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IdempotentKeyResolver idempotentKeyResolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IdempotentStorage idempotentStorage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IdempotentHandler idempotentHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SimpleIdempotentEngine(IdempotentKeyResolver idempotentKeyResolver, IdempotentStorage idempotentStorage, IdempotentHandler idempotentHandler) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentKeyResolver = idempotentKeyResolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentStorage = idempotentStorage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentHandler = idempotentHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void execute(Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = this.idempotentKeyResolver.resolve(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentStorage.store(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentHandler.handle(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Giải thích:<!-- -->
<ul>
<li>Mục đích dùng interface để chúng ta có thể dễ dàng thay đổi implement logic code bên trong.<!-- -->
<ul>
<li>IdempotentKeyResolver để lấy key từ các field của request.</li>
<li>IdempotentStorage để lấy lưu key vào redis, hoặc database.</li>
<li>IdempotentHandler để throw exception hoặc chỉ đơn giản là log.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tạo-các-interface-tương-ứng-bên-trên">Tạo các interface tương ứng bên trên<a href="#tạo-các-interface-tương-ứng-bên-trên" class="hash-link" aria-label="Direct link to Tạo các interface tương ứng bên trên" title="Direct link to Tạo các interface tương ứng bên trên">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface IdempotentEngine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void execute(Object[] args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface IdempotentKeyResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String resolve(Object[] args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface IdempotentHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Object handle(Object[] args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface IdempotentStorage {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void store(String key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tạo-annotation">Tạo annotation<a href="#tạo-annotation" class="hash-link" aria-label="Direct link to Tạo annotation" title="Direct link to Tạo annotation">​</a></h3>
<ul>
<li>Từ mỗi annotation trên method Controller, chúng ta sẽ tạo ra 1 IdempotentEngine tương ứng.</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Idempotent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String id();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int index();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class clazz();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String s();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Handle handleIdempotent() default @Handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>id: sẽ được dùng làm key để lấy ra IdempotentEngine tương ứng từ IdempotentEngineRegistry</li>
<li>index, clazz, s: sẽ được dùng để lấy ra key từ request</li>
<li>handleIdempotent: sẽ được dùng để thay đổi logic handle exception, mặc định sẽ là IdempotentHandlerImpl (xem annotation bên dưới)</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.ANNOTATION_TYPE})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Handle {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;? extends IdempotentHandler&gt; handlerClass() default IdempotentHandlerImpl.class;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>IdempotentHandlerImpl là 1 class implement IdempotentHandler, xem mục &#x27;các implement default&#x27;</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tạo-bean-spring">Tạo bean spring<a href="#tạo-bean-spring" class="hash-link" aria-label="Direct link to Tạo bean spring" title="Direct link to Tạo bean spring">​</a></h3>
<ul>
<li>class Constructor sẽ được tạo Bean bằng cách dùng @Import trong project chính.</li>
<li>Đây sẽ là 2 bean được khởi tạo đầu tiên<!-- -->
<ul>
<li>idempotentEngineRegistry() sẽ quét các bean trong project chính, tạo ra 1 <code>map&lt;String, IdempotentEngine&gt;</code> được lưu trong IdempotentEngineRegistry.</li>
<li>initIdempotentApo() sẽ được truyền vào IdempotentEngineRegistry, xem mục tạo AOP bên dưới để hiểu rõ hơn</li>
</ul>
</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Constructor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Constructor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentEngineRegistry idempotentEngineRegistry(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new IdempotentEngineRegistry(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentAop initIdempotentApo(IdempotentEngineRegistry idempotentEngineRegistry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new IdempotentAop(idempotentEngineRegistry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>class IdempotentEngineRegistry sẽ là nơi tạo engine từ các thông tin trên annotation, sau đó bỏ vào <code>Map&lt;String, IdempotentEngine&gt;</code>, IdempotentEngine sẽ được lấy ra bằng AOP, mỗi khi method của Controller được gọi.</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.libselflearn.library.spring;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.IdempotentEngine;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.IdempotentHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.IdempotentKeyResolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.IdempotentStorage;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.SimpleIdempotentEngine;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.annotations.Handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.annotations.Idempotent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.impl.IdempotentKeyResolverImpl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.libselflearn.library.impl.IdempotentStorageImpl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.annotation.Annotation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.BeanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.AnnotatedBeanDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.config.BeanDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.annotation.MergedAnnotation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.type.AnnotationMetadata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.core.type.MethodMetadata;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentEngineRegistry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public final Map&lt;String, IdempotentEngine&gt; enginesMap = new HashMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final AutowireCapableBeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public IdempotentEngineRegistry(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.beanFactory = (AutowireCapableBeanFactory)beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassPathScanningCandidateComponentProvider scanner = new ClassPathScanningCandidateComponentProvider(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;BeanDefinition&gt; beanDefinitionSet = scanner.findCandidateComponents(&quot;com.example.libselflearn&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinition beanDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(Iterator var4 = beanDefinitionSet.iterator(); var4.hasNext(); System.out.println(beanDefinition)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      beanDefinition = (BeanDefinition)var4.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (beanDefinition instanceof AnnotatedBeanDefinition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationMetadata annotationMetadata = ((AnnotatedBeanDefinition)beanDefinition).getMetadata();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;MethodMetadata&gt; methodMetadata = annotationMetadata.getAnnotatedMethods(Idempotent.class.getCanonicalName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Iterator var8 = methodMetadata.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while(var8.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          MethodMetadata metadata = (MethodMetadata)var8.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          this.createEngine(metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void createEngine(MethodMetadata methodMetadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAnnotation mergedAnnotation = methodMetadata.getAnnotations().get(Idempotent.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = mergedAnnotation.getString(&quot;id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int index = mergedAnnotation.getInt(&quot;index&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class clzz = mergedAnnotation.getClass(&quot;clazz&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String field = mergedAnnotation.getString(&quot;s&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdempotentKeyResolver idempotentKeyResolver = this.resolveKeyResolver(mergedAnnotation, index, clzz, field);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdempotentHandler idempotentHandler = this.resolveIdempotentHandler(mergedAnnotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdempotentStorage idempotentStorage = new IdempotentStorageImpl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SimpleIdempotentEngine simpleIdempotentEngine = new SimpleIdempotentEngine(idempotentKeyResolver, idempotentStorage, idempotentHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.enginesMap.put(key, simpleIdempotentEngine);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IdempotentKeyResolver resolveKeyResolver(MergedAnnotation mergedAnnotation, int index, Class clzz, String field) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new IdempotentKeyResolverImpl(index, clzz, field);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IdempotentHandler resolveIdempotentHandler(MergedAnnotation&lt;? extends Annotation&gt; mergedAnnotation) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAnnotation handleAnnotation = mergedAnnotation.getAnnotation(&quot;handleIdempotent&quot;, Handle.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (IdempotentHandler)this.createBean(handleAnnotation.getClass(&quot;handlerClass&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private &lt;T&gt; T createBean(Class&lt;T&gt; clazz) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return this.beanFactory.getBean(clazz);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception var3) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return this.beanFactory.createBean(clazz);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="các-implement-default">các implement default<a href="#các-implement-default" class="hash-link" aria-label="Direct link to các implement default" title="Direct link to các implement default">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentKeyResolverImpl implements IdempotentKeyResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Class clzz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String field;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentKeyResolverImpl(int index, Class clzz, String field) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.index = index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.field = field;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clzz = clzz;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolve(Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Field nameField = this.clzz.getDeclaredField(this.field);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nameField.setAccessible(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (String)nameField.get(args[this.index]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IllegalAccessException | NoSuchFieldException var3) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(var3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentHandlerImpl implements IdempotentHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentHandlerImpl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object handle(Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;huy is here&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentStorageImpl implements IdempotentStorage {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentStorageImpl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void store(String key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;I will save key: &quot; + key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tạo-aop">Tạo AOP<a href="#tạo-aop" class="hash-link" aria-label="Direct link to Tạo AOP" title="Direct link to Tạo AOP">​</a></h3>
<ul>
<li>Mục đích: chúng ta sẽ chạy method beforeIdempotentAnnotation mỗi khi method của Controller được gọi (chạy trước).</li>
<li>IdempotentAop sẽ chứa IdempotentEngineRegistry (chứa <code>Map&lt;String,IdempotentEngine&gt;</code>), để lấy đúng engine cần thiết từ id (lấy từ JoinPoint)</li>
<li>JoinPoint là 1 khái niệm của AOP, có thể lấy ra các data cần thiết từ method của Controller.</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Aspect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentAop {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final IdempotentEngineRegistry idempotentEngineRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentAop(IdempotentEngineRegistry idempotentEngineRegistry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.idempotentEngineRegistry = idempotentEngineRegistry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Before(&quot;@annotation(com.example.libselflearn.library.annotations.Idempotent)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void beforeIdempotentAnnotation(JoinPoint joinPoint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = joinPoint.getArgs();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MethodSignature signature = (MethodSignature)joinPoint.getSignature();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Idempotent annotation = (Idempotent)signature.getMethod().getDeclaredAnnotation(Idempotent.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = annotation.id();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ((IdempotentEngine)this.idempotentEngineRegistry.enginesMap.get(key)).execute(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-run">How to run<a href="#how-to-run" class="hash-link" aria-label="Direct link to How to run" title="Direct link to How to run">​</a></h2>
<ul>
<li>Tạo 1 bean class dùng @Import</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Import({Constructor.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class IdempotentConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IdempotentConfig() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/java/kafka-with-java-springboot-example"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ví dụ kafka + java springboot</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/kafka/kafka-basic"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kafka</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tóm-tắt" class="table-of-contents__link toc-highlight">Tóm tắt</a></li><li><a href="#prequisites" class="table-of-contents__link toc-highlight">Prequisites</a></li><li><a href="#project-structure" class="table-of-contents__link toc-highlight">Project structure</a></li><li><a href="#hiện-thực" class="table-of-contents__link toc-highlight">Hiện thực</a><ul><li><a href="#tạo-spi" class="table-of-contents__link toc-highlight">Tạo spi</a></li><li><a href="#tạo-annotation" class="table-of-contents__link toc-highlight">Tạo annotation</a></li><li><a href="#tạo-bean-spring" class="table-of-contents__link toc-highlight">Tạo bean spring</a></li><li><a href="#tạo-aop" class="table-of-contents__link toc-highlight">Tạo AOP</a></li></ul></li><li><a href="#how-to-run" class="table-of-contents__link toc-highlight">How to run</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>